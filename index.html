<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>🎮 دکتر N – ماشین سکه‌ای لاکچری</title>
<link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet">
<style>
  body, html { margin:0; padding:0; overflow:hidden; background: linear-gradient(135deg,#ffe082,#f48fb1); font-family: Vazirmatn; }
  #logo { position:absolute; top:10px; left:50%; transform:translateX(-50%); font-size:32px; color:#fff; text-shadow:0 0 10px #000; animation: bounce 1.5s infinite;}
  @keyframes bounce { 0%,100%{transform:translate(-50%,0)} 50%{transform:translate(-50%,-10px);} }
  canvas { display:block; margin:auto; background: linear-gradient(to bottom,#bbdefb,#e3f2fd); border:5px solid #fff; border-radius:16px; box-shadow:0 0 30px #ff4081aa; }
  .panel { position:absolute; top:60px; left:50%; transform:translateX(-50%); background:rgba(255,255,255,0.95); padding:20px; border-radius:16px; box-shadow:0 0 30px #00000055; width:320px; text-align:center; z-index:10; display:none; }
  input,select,button { width:100%; padding:12px; margin-top:10px; border:none; border-radius:8px; font-size:16px; }
  button { background: linear-gradient(to right,#ec407a,#d81b60); color:#fff; font-weight:bold; cursor:pointer; transition:0.2s; }
  button:hover { transform:scale(1.03); }
  #progressBarContainer { position:absolute; bottom:120px; left:50%; transform:translateX(-50%); width:80%; max-width:400px; background:#ffebee; border-radius:10px; height:22px; box-shadow:inset 0 1px 3px rgba(0,0,0,0.2); z-index:10; display:none;}
  #progressBar { width:0%; height:100%; background:linear-gradient(to right,#ef5350,#e53935); border-radius:10px; transition:width 0.4s ease; }
  #transferPanel { top:130px; }
  #scoreList { text-align:left; max-height:200px; overflow-y:auto; margin-top:10px; direction:ltr; }
</style>
</head>
<body>
<div id="logo">🎉 دکتر N – ماشین سکه‌ای لاکچری</div>
<canvas id="gameCanvas" width="400" height="600"></canvas>

<div id="loginPanel" class="panel">
  <h3>ورود / ورود مدیر</h3>
  <input id="licenseCode" placeholder="کد لایسنس">
  <button onclick="login()">ورود کاربر</button>
  <button onclick="adminLogin()">پنل مدیریت</button>
  <div id="scoreList"></div>
</div>

<div id="adminPanel" class="panel">
  <h3>مدیریت لایسنس</h3>
  <input id="adminCode" placeholder="کد لایسنس">
  <input id="duration" type="number" placeholder="مدت (روز)" min="1">
  <select id="tier"><option value="bronze">برنز</option><option value="silver">نقره</option><option value="gold">طلا</option></select>
  <button onclick="generateOrChargeLicense()">ثبت / شارژ</button>
  <div id="adminOutput"></div>
</div>

<div id="transferPanel" class="panel">
  <h3>انتقال پول</h3>
  <input id="recipientCode" placeholder="کد 6 رقمی گیرنده">
  <input id="transferAmount" type="number" placeholder="مبلغ (تومان)">
  <button onclick="transferCoins()">ارسال</button>
</div>

<div id="progressBarContainer"><div id="progressBar"></div></div>

<script>
let licenseCode='', tier='bronze', coinCount=0;
const values={bronze:2000,silver:4000,gold:6000}, dragons=[], coinsArr=[];

// مدیریت لایسنس
function login(){
  const code=document.getElementById('licenseCode').value.trim();
  const lic=JSON.parse(localStorage.getItem('licenses')||'{}')[code];
  if(lic && Date.now()<lic.expires){
    licenseCode=code; tier=lic.tier; coinCount=lic.coins||0;
    document.getElementById('loginPanel').style.display='none';
    document.getElementById('adminPanel').style.display='none';
    document.getElementById('transferPanel').style.display='block';
    document.getElementById('progressBarContainer').style.display='block';
    updateProgressBar(lic); loadScores();
    startGame();
  } else alert('کد اشتباه یا منقضی!')
}

function adminLogin(){
  const pass=prompt('رمز مدیر:');
  if(pass==='Ali.dr.N.'){
    document.getElementById('loginPanel').style.display='none';
    document.getElementById('adminPanel').style.display='block';
    document.getElementById('transferPanel').style.display='none';
  } else alert('رمز اشتباه!')
}

function generateOrChargeLicense(){
  const code=document.getElementById('adminCode').value.trim(), days=parseInt(document.getElementById('duration').value), t=document.getElementById('tier').value;
  if(!code||!days)return alert('اطلاعات ناقص!');
  const a=JSON.parse(localStorage.getItem('licenses')||'{}');
  const now=Date.now();
  a[code]={tier:t,expires:now+days*86400000,totalDays:days,coins: a[code]?a[code].coins:0};
  localStorage.setItem('licenses',JSON.stringify(a));
  document.getElementById('adminOutput').innerText=`✅ ${code} برای ${days} روز ثبت شد`;
}

function transferCoins(){
  const r=document.getElementById('recipientCode').value.trim(), amt=parseInt(document.getElementById('transferAmount').value);
  const lic=JSON.parse(localStorage.getItem('licenses')||'{}');
  if(!lic[licenseCode])return alert('ابتدا وارد شوید');
  if(isNaN(amt)||amt<1)return alert('عدد صحیح!');
  if(lic[licenseCode].coins*values[lic[licenseCode].tier]<amt)return alert('اعتبار کم است');
  const rec=Object.values(lic).find(v=>v.code&&v.code.toString()===r);
  if(!rec)return alert('گیرنده یافت نشد');
  lic[licenseCode].coins-=Math.floor(amt/values[tier]);
  rec.coins+=Math.floor(amt/values[rec.tier]);
  localStorage.setItem('licenses',JSON.stringify(lic));
  alert('انتقال انجام شد'); loadScores();
}

// پیشرفت اشتراک
function updateProgressBar(lic){
  const daysLeft=Math.ceil((lic.expires-Date.now())/86400000);
  const perc=Math.max(0,Math.min(100,daysLeft/lic.totalDays*100));
  document.getElementById('progressBar').style.width=perc+'%';
  document.getElementById('progressBar').title=daysLeft+' روز باقی';
}

// جدول امتیازات
function loadScores(){
  const lic=JSON.parse(localStorage.getItem('licenses')||'{}');
  const arr=Object.entries(lic).map(([k,v])=> ({code:k,coins:v.coins||0})).sort((a,b)=>b.coins-a.coins);
  const html=arr.slice(0,5).map(o=>`${o.code}: ${o.coins} سکه`).join('<br>');
  document.getElementById('scoreList').innerHTML=html;
}

// بازی ماشین
const canvas=document.getElementById('gameCanvas'), ctx=canvas.getContext('2d');
const car={x:180,y:520,w:40,h:60,color:'#d32f2f'};
let gameInterval;

function startGame(){
  dragons.length=0; coinsArr.length=0;
  document.addEventListener('keydown',e=>{
    if(e.key==='ArrowLeft')car.x=Math.max(0,car.x-30);
    if(e.key==='ArrowRight')car.x=Math.min(canvas.width-car.w,car.x+30);
  });
  gameInterval=setInterval(updateGame,30);
}

function updateGame(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle=car.color; ctx.fillRect(car.x,car.y,car.w,car.h);
  if(Math.random()<0.02) dragons.push({x:Math.random()*360+20,y:-60});
  if(Math.random()<0.05) coinsArr.push({x:Math.random()*360+20,y:-20});

  dragons.forEach((d,i)=>{
    d.y+=4; ctx.fillStyle='#666'; ctx.beginPath();
    ctx.moveTo(d.x,d.y); ctx.lineTo(d.x-15,d.y+40); ctx.lineTo(d.x+15,d.y+40); ctx.fill();
    if(d.y>canvas.height||d.y>car.y && Math.abs(d.x-car.x)<30) dragons.splice(i,1);
  });

  coinsArr.forEach((c,i)=>{
    c.y+=5; ctx.beginPath(); ctx.arc(c.x,c.y,10,0,2*Math.PI);
    ctx.fillStyle='gold'; ctx.fill();
    if(c.y>canvas.height)coinsArr.splice(i,1);
    else if(c.y>car.y && Math.abs(c.x-car.x)<25){
      coinsArr.splice(i,1); coinCount++;
      const lic=JSON.parse(localStorage.getItem('licenses'));
      lic[licenseCode].coins=coinCount;
      localStorage.setItem('licenses',JSON.stringify(lic));
      loadScores();
    }
  });

  ctx.fillStyle='#222'; ctx.font='20px Vazirmatn'; ctx.fillText('سکه: '+coinCount,10,30);
}
</script>
</body>
</html>
